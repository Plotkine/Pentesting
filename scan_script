#!/bin/bash

#####################
#TESTING PARAMETERS
#####################

if [ $# -ne 1 ]
then
	echo "Wrong number of arguments.. exiting"
	exit -1
elif [ $(id -u) -ne 0 ]
then
	echo "You must run this script as root.. exiting"
	exit -1
fi

script_start=`date +%s`;

#####################
#CODE
#####################

for host in $(cat $1); do
	host_start=`date +%s`
	n=0

        echo -e "\e[1m$host\e[0m"
	echo -e "\e[1m[*]\e[0m Creating folder..."
	echo ""
	echo -e "\e[1m\e[4mTasks\e[0m"
	echo ""
	mkdir $host
	cd $host
	
	n=$(($n + 1))
	echo -e "\e[1m[$n]\e[0m Full TCP scan (all ports)"

	n=$(($n + 1))
	echo -e "\e[1m[$n]\e[0m UDP scan (1000 ports)"

	sudo nmap -sT -p- $host -Pn -n > nmap_full_TCP_allports &
	sudo nmap -sU $host -Pn -n > nmap_UDP & #1000 most well-known ports
	wait

	echo ""
	echo -e "\e[1m[Done]\e[0m"
	echo ""

	#number of open TCP ports
	open_TCP_ports=`cat nmap_full_TCP_allports |grep open |grep tcp |wc -l`
        
	#list of open TCP ports
	open_TCP_ports_list=""
	for port in `cat nmap_full_TCP_allports |grep open |grep tcp |cut -d / -f 1`; do open_TCP_ports_list="$open_TCP_ports_list$port,"; done
	open_TCP_ports_list=`echo $open_TCP_ports_list |sed 's/.$//'` #removing last ","

	#number of open UDP ports
	open_UDP_ports=`cat nmap_UDP |grep open |grep udp |wc -l`

        #list of open UDP ports
	open_UDP_ports_list=""
	for port in `cat nmap_UDP |grep open |grep udp |cut -d / -f 1`; do open_UDP_ports_list="$open_UDP_ports_list$port,"; done
	open_UDP_ports_list=`echo $open_UDP_ports_list |sed 's/.$//'` #removing last ","

	if [ $open_TCP_ports -ge 1 ]; then
		n=$(($n + 1))
		echo -e "\e[1m[$n]\e[0m TCP versions scan"

		sudo nmap -sTV -p $open_TCP_ports_list $host -Pn -n > nmap_full_TCP_versions &

		n=$(($n + 1))
		echo -e "\e[1m[$n]\e[0m TCP default scripts"
		sudo nmap -sTC -p $open_TCP_ports_list $host -Pn -n > nmap_full_TCP_scripts &
	fi

	if [ $open_UDP_ports -ge 1 ]; then
		n=$(($n + 1))
		echo -e "\e[1m[$n]\e[0m UDP versions scan"
		sudo nmap -sUV -p $open_UDP_ports_list $host -Pn -n > nmap_UDP_versions &

		n=$(($n + 1))
		echo -e "\e[1m[$n]\e[0m UDP default scripts"
		sudo nmap -sUC -p $open_UDP_ports_list $host -Pn -n > nmap_UDP_scripts  &
	fi

	n=$(($n + 1))
	echo -e "\e[1m[$n]\e[0m OS detection"

	if [ $open_TCP_ports -ge 1 ] && [ $open_UDP_ports -ge 1 ]; then
		sudo nmap -O $host -p T:$open_TCP_ports_list,U:$open_UDP_ports_list --osscan-guess -Pn -n > nmap_OS_detection &
	elif [ $open_TCP_ports -ge 1 ]; then
		sudo nmap -O $host -p $open_TCP_ports_list --osscan-guess -Pn -n > nmap_OS_detection &
	fi

	n=$(($n + 1))
	echo -e "\e[1m[$n]\e[0m OS agressive detection"

	if [ $open_TCP_ports -ge 1 ] && [ $open_UDP_ports -ge 1 ]; then
		sudo nmap -A -n $host -p T:$open_TCP_ports_list,U:$open_UDP_ports_list -Pn -n > nmap_OS_agressive_detection &
	elif [ $open_TCP_ports -ge 1 ]; then
		sudo nmap -A -n $host -p $open_TCP_ports_list -Pn -n > nmap_OS_agressive_detection &
	fi

	wait

	echo ""	> all_in_one
	echo -e "\e[91m\e[1mTCP VERSIONS\e[0m\e[92m" >> all_in_one
	echo "" >> all_in_one
	cat nmap_full_TCP_versions >> all_in_one
	echo "--------------------------------------------" >> all_in_one
	echo -e "\e[91m\e[1mUDP VERSIONS\e[0m\e[92m" >> all_in_one
	echo "" >> all_in_one
	cat nmap_UDP_versions >> all_in_one
	echo "--------------------------------------------" >> all_in_one
	echo -e "\e[91m\e[1mTCP SCRIPTS\e[0m\e[92m" >> all_in_one
	echo "" >> all_in_one
	cat nmap_full_TCP_scripts >> all_in_one
	echo "--------------------------------------------" >> all_in_one
	echo -e "\e[91m\e[1mUDP SCRIPTS\e[0m\e[92m" >> all_in_one
	echo "" >> all_in_one
	cat nmap_UDP_scripts >> all_in_one
	echo "--------------------------------------------" >> all_in_one
	echo -e "\e[91m\e[1mOS DETECTION\e[0m\e[92m" >> all_in_one
	echo "" >> all_in_one
	cat nmap_OS_detection >> all_in_one
	echo "--------------------------------------------" >> all_in_one
	echo -e "\e[91m\e[1mOS AGRESSIVE DETECTION\e[0m\e[92m" >> all_in_one
	echo "" >> all_in_one
	cat nmap_OS_agressive_detection >> all_in_one
	
	echo ""
	echo -e "\e[1m[Done]\e[0m"
	echo ""

	echo "$open_TCP_ports open TCP ports: $open_TCP_ports_list" > LOGS
        echo "$open_UDP_ports open UDP ports: $open_UDP_ports_list" >> LOGS
	echo "$open_TCP_ports open TCP ports: $open_TCP_ports_list"
        echo "$open_UDP_ports open UDP ports: $open_UDP_ports_list"


	host_end=`date +%s`
	echo -e "\e[1mScan completed\e[0m in $((host_end - host_start)) seconds." >> LOGS
	echo -e "\e[1mScan completed\e[0m in $((host_end - host_start)) seconds."
	echo "--------------------------------------------"
	cd ..
done

script_end=`date +%s`;
echo -e "\e[1mScript completed\e[0m in $((script_end - script_start)) seconds.";
