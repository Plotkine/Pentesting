#!/bin/bash

#####################
#TESTING PARAMETERS
#####################

if [ $# -ne 1 ]
then
        echo "Wrong number of arguments.. exiting"
        exit -1
elif [ $(id -u) -ne 0 ]
then
        echo "You must run this script as root.. exiting"
        exit -1
fi

script_start=`date +%s`;

#####################
#CODE
#####################

echo ""

#echo "--------------------------------------------"
echo -e "\e[93m\e[1mHosts:\e[0m"
#echo ""
for host in $(cat $1); do
        echo -e "\e[33m$host\e[0m"
done
#echo "--------------------------------------------"

echo ""

scan() {
        host=$1
        host_start=`date +%s`

        #n=0

        #echo -e "\e[1m$host\e[0m"
        mkdir $host
        #echo -e "\e[1m\e[93m[done]\e[0m \e[33m$host\e[0m Creating folder"
        #echo ""
        #echo -e "\e[1m\e[4mTasks\e[0m"
        #echo ""

        #n=$(($n + 1))
        #echo -e "\e[1m[running]\e[0m $host: TCP SYN scan (-T5, all ports)"

        #n=$(($n + 1))
        #echo -e "\e[1m[running]\e[0m $host: UDP scan (-T5, 1000 ports)"

        sudo nmap -sS -p- $host -Pn -n -T5 > ./$host/nmap_full_TCP_allports && echo -e "\e[93m\e[1m[done]\e[0m \e[33m$host\e[0m TCP SYN scan" &
        sudo nmap -sU $host -Pn -n -T5 > ./$host/nmap_UDP && echo -e "\e[93m\e[1m[done]\e[0m \e[33m$host\e[0m UDP scan"& #1000 most well-known ports
        
        wait

        #number of open TCP ports
        open_TCP_ports=`cat ./$host/nmap_full_TCP_allports |grep open |grep tcp |wc -l`
        
        #list of open TCP ports
        open_TCP_ports_list=""
        for port in `cat ./$host/nmap_full_TCP_allports |grep open |grep tcp |cut -d / -f 1`; do open_TCP_ports_list="$open_TCP_ports_list$port,"; done
        open_TCP_ports_list=`echo $open_TCP_ports_list |sed 's/.$//'` #removing last ","

        #number of open UDP ports
        open_UDP_ports=`cat ./$host/nmap_UDP |grep open |grep udp |wc -l`

        #list of open UDP ports
        open_UDP_ports_list=""
        for port in `cat ./$host/nmap_UDP |grep open |grep udp |cut -d / -f 1`; do open_UDP_ports_list="$open_UDP_ports_list$port,"; done
        open_UDP_ports_list=`echo $open_UDP_ports_list |sed 's/.$//'` #removing last ","

        if [ $open_TCP_ports -ge 1 ]; then
                #n=$(($n + 1))
                #echo -e "\e[1m[running]\e[0m $host: TCP versions scan"

                sudo nmap -sTV -p $open_TCP_ports_list $host -Pn -n > ./$host/nmap_full_TCP_versions && echo -e "\e[93m\e[1m[done]\e[0m \e[33m$host\e[0m TCP versions scan" &

                #n=$(($n + 1))
                #echo -e "\e[1m[running]\e[0m $host: TCP default scripts"
                sudo nmap -sTC -p $open_TCP_ports_list $host -Pn -n > ./$host/nmap_full_TCP_scripts && echo -e "\e[93m\e[1m[done]\e[0m \e[33m$host\e[0m TCP default scripts" &
        fi

        if [ $open_UDP_ports -ge 1 ]; then
                #n=$(($n + 1))
                #echo -e "\e[1m[running]\e[0m $host: UDP versions scan"
                sudo nmap -sUV -p $open_UDP_ports_list $host -Pn -n > ./$host/nmap_UDP_versions && echo -e "\e[93m\e[1m[done]\e[0m \e[33m$host\e[0m UDP versions scan" &

                #n=$(($n + 1))
                #echo -e "\e[1m[running]\e[0m $host: UDP default scripts"
                sudo nmap -sUC -p $open_UDP_ports_list $host -Pn -n > ./$host/nmap_UDP_scripts && echo -e "\e[93m\e[1m[done]\e[0m \e[93m$host\e[0m UDP defaults scripts" & 
        fi

                #n=$(($n + 1))
        #echo -e "\e[1m[$n]\e[0m OS detection"

        #if [ $open_TCP_ports -ge 1 ] && [ $open_UDP_ports -ge 1 ]; then
        #       sudo nmap -O $host -p T:$open_TCP_ports_list,U:$open_UDP_ports_list --osscan-guess -Pn -n > nmap_OS_detection &
        #elif [ $open_TCP_ports -ge 1 ]; then
        #       sudo nmap -O $host -p $open_TCP_ports_list --osscan-guess -Pn -n > nmap_OS_detection &
        #fi

        #n=$(($n + 1))
        #echo -e "\e[1m[running]\e[0m $host: OS agressive detection (-T5)"

        if [ $open_TCP_ports -ge 1 ] && [ $open_UDP_ports -ge 1 ]; then
                sudo nmap -A -n $host -p T:$open_TCP_ports_list,U:$open_UDP_ports_list, -Pn -n -T5 > ./$host/nmap_OS_agressive_detection &
        elif [ $open_TCP_ports -ge 1 ]; then
                sudo nmap -A -n $host -p $open_TCP_ports_list -Pn -n -T5 > ./$host/nmap_OS_agressive_detection && echo -e "\e[93m\e[1m[done]\e[0m \e[33m$host\e[0m OS agressive detection" &
        fi

        wait

        echo "" > ./$host/all_in_one
        echo -e "\e[91m\e[1mTCP VERSIONS\e[0m\e[92m" >> ./$host/all_in_one
        echo "" >> ./$host/all_in_one
        cat ./$host/nmap_full_TCP_versions >> ./$host/all_in_one
        if [ $open_UDP_ports -ge 1 ]; then
                echo "--------------------------------------------" >> ./$host/all_in_one
                echo -e "\e[91m\e[1mUDP VERSIONS\e[0m\e[92m" >> ./$host/all_in_one
                echo "" >> ./$host/all_in_one
                cat ./$host/nmap_UDP_versions >> ./$host/all_in_one
        fi
        echo "--------------------------------------------" >> ./$host/all_in_one
        echo -e "\e[91m\e[1mTCP SCRIPTS\e[0m\e[92m" >> ./$host/all_in_one
        echo "" >> ./$host/all_in_one
        cat ./$host/nmap_full_TCP_scripts >> ./$host/all_in_one
        if [ $open_UDP_ports -ge 1 ]; then
                echo "--------------------------------------------" >> ./$host/all_in_one
                echo -e "\e[91m\e[1mUDP SCRIPTS\e[0m\e[92m" >> ./$host/all_in_one
                echo "" >> ./$host/all_in_one
                cat ./$host/nmap_UDP_scripts >> ./$host/all_in_one
        fi
        echo "--------------------------------------------" >> ./$host/all_in_one
        #echo -e "\e[91m\e[1mOS DETECTION\e[0m\e[92m" >> ./$host/all_in_one
        #echo "" >> ./$host/all_in_one
        #cat nmap_OS_detection >> ./$host/all_in_one
        echo "--------------------------------------------" >> ./$host/all_in_one
        echo -e "\e[91m\e[1mOS AGRESSIVE DETECTION\e[0m" >> ./$host/all_in_one
        echo "" >> ./$host/all_in_one
        cat ./$host/nmap_OS_agressive_detection >> ./$host/all_in_one

        echo ""

        host_end=`date +%s`
        #echo "--------------------------------------------"
        echo -e "\e[93m\e[1m$host \e[34mscanned in $((host_end - host_start)) seconds\e[0m" >> ./$host/LOGS
        echo -e "\e[93m\e[1m$host \e[34mscanned in $((host_end - host_start)) seconds\e[0m"

        #echo ""

        echo "$open_TCP_ports open TCP ports: $open_TCP_ports_list" >> ./$host/LOGS
        echo "$open_UDP_ports open UDP ports: $open_UDP_ports_list" >> ./$host/LOGS
        #echo "Open ports:"
        echo -e "\e[34m\e[1mTCP: $open_TCP_ports_list\e[0m"
        echo -e "\e[34m\e[1mUDP: $open_UDP_ports_list\e[0m"
        #echo "--------------------------------------------"

        echo ""

}

#PARALLELIZING

for host in $(cat $1); do
        scan $host &
done

wait

#echo "--------------------------------------------"
script_end=`date +%s`;
echo -e "\e[1mScript completed in $((script_end - script_start)) seconds\e[0m";
#echo "--------------------------------------------"

#echo ""
